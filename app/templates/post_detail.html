{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <!-- Post Header -->
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="fw-bold mb-1">{{ post.title }}</h2>
                <small class="text-muted">
                    By <a href="{{ url_for('main.user', username=post.author.username) }}" class="fw-semibold">
                        {{ post.author.username }}
                    </a> Â· {{ moment(post.timestamp).format('LLL') }}
                </small>
            </div>
            {% if current_user.is_admin %}
            <form method="post" action="{{ url_for('admin.delete_post', post_id=post.id) }}">
                {{ form.hidden_tag() }}
                <input type="hidden" name="next" value="{{ url_for('admin.admin_dashboard') }}">
                <button type="submit" class="btn btn-danger btn-sm">
                    Delete Post
                </button>
            </form>
            {% endif %}
        </div>

        <hr>

        <!-- Post Content -->
        <div class="fs-5" style="min-height: 200px;">
            {% if post.image %}
            <div class="text-center mb-3">
                <a href="{{ url_for('static', filename='uploads/' ~ post.image) }}" target="_blank">
                    <img src="{{ url_for('static', filename='uploads/' ~ post.image) }}" alt="Post image"
                        class="img-fluid rounded shadow-sm" style="max-height: 500px; object-fit: cover;">
                </a>
            </div>
            {% endif %}
            <p class="mt-3">{{ post.body | replace('\n', '<br>') | safe }}</p>
        </div>
        {% if post.author == current_user %}
        <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="btn btn-warning mb-1">Edit</a>
        <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="post">
            {{ form.hidden_tag() }}
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Comment Form -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <h5 class="fw-bold mb-3">ðŸ’¬ Leave a Comment</h5>
        {{ wtf.quick_form(form, action=url_for('main.make_comment', post_id=post.id)) }}
    </div>
</div>

<!-- Comments Section -->
<h4 class="fw-bold mb-3">Comments ({{ post.comment_count() }})</h4>

{% if comments %}
{% for comment in comments %}
<div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
        <div class="d-flex align-items-start">
            <!-- Avatar -->
            <a href="{{ url_for('main.user', username=comment.author.username) }}">
                <img src="{{ comment.author.avatar(50) }}" alt="{{ comment.author.username }}'s avatar"
                    class="rounded-circle me-3 border" style="width:50px; height:50px; object-fit:cover;">
            </a>
            <div class="flex-grow-1">
                <!-- Author & Timestamp -->
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{{ url_for('main.user', username=comment.author.username) }}"
                            class="fw-semibold text-dark">
                            {{ comment.author.username }}
                        </a>
                        <small class="text-muted ms-2">{{ moment(comment.timestamp).format('LLL') }}</small>
                    </div>
                    {% if current_user.is_admin %}
                    <form method="post" action="{{ url_for('admin.delete_comment', comment_id=comment.id) }}">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="next" value="{{ url_for('main.post_detail', post_id=post.id) }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                    {% endif %}
                </div>

                <!-- Comment Body -->
                <p class="mt-2 mb-0">{{ comment.body }}</p>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<p class="text-muted fst-italic">No comments yet. Be the first to comment!</p>
{% endif %}

<!-- Pagination -->
{% if comments %}
<nav aria-label="Comment navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item{% if not prev_url %} disabled{% endif %}">
            <a href="{{ prev_url or '#' }}" class="page-link">
                <span aria-hidden="true">&larr;</span> {{ _('Newer') }}
            </a>
        </li>
        <li class="page-item{% if not next_url %} disabled{% endif %}">
            <a href="{{ next_url or '#' }}" class="page-link">
                {{ _('Older') }} <span aria-hidden="true">&rarr;</span>
            </a>
        </li>
    </ul>
</nav>
{% endif %}
{% endblock %}